<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Tr·ª£ l√Ω AI CSKH ‚Äì Demo</title>
  <style>
    :root{
      --bg:#0b0f1a;
      --card:#0f1626;
      --card2:#0c1220;
      --text:#eaf0ff;
      --muted:rgba(234,240,255,.72);
      --line:rgba(255,255,255,.10);

      --primary:#3b82f6;     /* xanh th∆∞∆°ng m·∫°i */
      --primary2:#2563eb;
      --primaryText:#ffffff;

      --botBg:rgba(255,255,255,.06);
      --botLine:rgba(255,255,255,.10);
      --meBg:rgba(59,130,246,.18);
      --meLine:rgba(59,130,246,.30);

      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --r:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1100px 650px at 80% -10%, rgba(59,130,246,.20), transparent 55%),
        radial-gradient(900px 540px at 10% 0%, rgba(34,197,94,.10), transparent 55%),
        var(--bg);
      color:var(--text);
      overflow:hidden;
    }

    /* ====== Minimal header (small, not heavy) ====== */
    .miniHeader{
      position:fixed;
      top:14px; left:14px; right:14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      z-index:10;
      pointer-events:none;
    }
    .miniBrand{
      pointer-events:auto;
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:999px;
      background:rgba(255,255,255,.04);
      border:1px solid var(--line);
      backdrop-filter: blur(10px);
    }
    .badge{
      width:30px;height:30px;border-radius:10px;
      display:grid;place-items:center;
      background:rgba(59,130,246,.16);
      border:1px solid rgba(59,130,246,.25);
      font-weight:800;
      letter-spacing:.2px;
    }
    .miniBrand b{font-size:13px}
    .miniBrand span{font-size:12px;color:var(--muted)}
    .miniRight{
      pointer-events:auto;
      display:flex; gap:8px; align-items:center;
    }
    .linkPill{
      font-size:12px;
      padding:9px 11px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--text);
      text-decoration:none;
    }

    /* ====== Floating chat widget ====== */
    .widget{
      position:fixed;
      right:16px;
      bottom: max(16px, env(safe-area-inset-bottom));
      width: min(420px, calc(100vw - 32px));
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      overflow:hidden;
      z-index:20;
    }

    .wTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 12px;
      background: rgba(255,255,255,.02);
      border-bottom:1px solid var(--line);
    }
    .wTitle{
      display:flex; flex-direction:column; gap:2px; min-width:0;
    }
    .wTitle b{font-size:13px; letter-spacing:.2px}
    .wTitle small{
      font-size:12px; color:var(--muted);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .dot{
      display:inline-block;
      width:7px;height:7px;border-radius:50%;
      background:#22c55e;
      margin-right:6px;
      transform: translateY(-1px);
    }
    .dot.off{background:#ef4444;}

    .wBtns{display:flex; gap:8px; align-items:center;}
    .iconBtn{
      width:34px;height:34px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--text);
      cursor:pointer;
    }
    .iconBtn:hover{background:rgba(255,255,255,.05)}

    .wBody{
      height: 360px; /* nh·ªè g·ªçn */
      max-height: 60vh;
      overflow:auto;
      padding:12px;
      background: rgba(12,18,32,.55);
    }

    .msg{display:flex; margin:10px 0;}
    .msg.me{justify-content:flex-end}
    .bubble{
      max-width: 86%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--botLine);
      background: var(--botBg);
      white-space:pre-wrap;
      line-height:1.45;
      font-size:14px;
    }
    .me .bubble{
      background: var(--meBg);
      border-color: var(--meLine);
    }

    /* typing */
    .typing{
      display:flex; align-items:center; gap:8px;
      font-size:12px; color:var(--muted);
      padding:8px 2px 0;
    }
    .dots{display:flex; gap:4px; align-items:center}
    .dots i{
      width:6px;height:6px;border-radius:50%;
      background: rgba(234,240,255,.55);
      animation: b 1.1s infinite ease-in-out;
    }
    .dots i:nth-child(2){animation-delay:.15s}
    .dots i:nth-child(3){animation-delay:.3s}
    @keyframes b{
      0%,80%,100%{transform: translateY(0); opacity:.55}
      40%{transform: translateY(-4px); opacity:1}
    }

    .wDock{
      padding:12px;
      border-top:1px solid var(--line);
      background: rgba(15,22,38,.88);
      backdrop-filter: blur(12px);
    }
    .composer{display:flex; gap:10px; align-items:flex-end;}
    textarea{
      flex:1;
      min-height:44px;
      max-height:110px;
      resize:vertical;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(11,15,26,.92);
      color: var(--text);
      outline:none;
      font-size:14px;
      line-height:1.35;
    }
    textarea::placeholder{color:rgba(234,240,255,.52)}

    .sendBtn{
      height:44px;
      padding:0 14px;
      border-radius:14px;
      border:1px solid rgba(59,130,246,.35);
      background: linear-gradient(180deg, var(--primary), var(--primary2));
      color: var(--primaryText);
      cursor:pointer;
      font-weight:700;
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
      box-shadow: 0 10px 26px rgba(37,99,235,.20);
    }
    .sendBtn:disabled{opacity:.65; cursor:not-allowed; box-shadow:none}

    .sub{
      margin-top:8px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      font-size:12px;
      color: var(--muted);
    }
    .sub a{color:#93c5fd; text-decoration:none}

    /* collapsed state */
    .widget.collapsed .wBody,
    .widget.collapsed .wDock{display:none;}
    .widget.collapsed{width:min(360px, calc(100vw - 32px));}

    /* small devices */
    @media (max-width: 420px){
      .wBody{height: 320px;}
      .miniHeader{top:10px;left:10px;right:10px;}
    }
  </style>
</head>
<body>

  <!-- Minimal header -->
  <div class="miniHeader">
    <div class="miniBrand">
      <div class="badge">AI</div>
      <div style="display:flex;flex-direction:column;gap:1px;min-width:0">
        <b>Tr·ª£ l√Ω AI CSKH</b>
        <span style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">T∆∞ v·∫•n theo d·ªØ li·ªáu doanh nghi·ªáp ‚Ä¢ Kh√¥ng cam k·∫øt ‚Äúkh·ªèi b·ªánh‚Äù</span>
      </div>
    </div>
    <div class="miniRight">
      <a class="linkPill" href="/health" target="_blank" rel="noopener">Health</a>
    </div>
  </div>

  <!-- Floating widget -->
  <div class="widget" id="widget">
    <div class="wTop">
      <div class="wTitle">
        <b>AI Assistant</b>
        <small><span id="dot" class="dot"></span><span id="status">ƒêang ki·ªÉm tra k·∫øt n·ªëi‚Ä¶</span></small>
      </div>
      <div class="wBtns">
        <button class="iconBtn" id="btnClear" title="Xo√° h·ªôi tho·∫°i">üßπ</button>
        <button class="iconBtn" id="btnToggle" title="Thu g·ªçn / M·ªü r·ªông">‚ñæ</button>
      </div>
    </div>

    <div class="wBody" id="chat"></div>

    <div class="wDock">
      <div class="composer">
        <textarea id="txt" placeholder="Nh·∫≠p c√¢u h·ªèi‚Ä¶ (VD: Ng∆∞·ªùi b·ªã ti·ªÉu ƒë∆∞·ªùng d√πng combo n√†o?)"></textarea>
        <button class="sendBtn" id="send">
          <span>G·ª≠i</span>
          <span aria-hidden="true">‚û§</span>
        </button>
      </div>
      <div class="sub">
        <span>‚èé Enter g·ª≠i ‚Ä¢ Shift+Enter xu·ªëng d√≤ng</span>
        <span><a href="#" id="btnExample">Xem v√≠ d·ª•</a></span>
      </div>
    </div>
  </div>

<script>
  const API = location.origin;

  const chat = document.getElementById("chat");
  const txt = document.getElementById("txt");
  const btn = document.getElementById("send");
  const btnClear = document.getElementById("btnClear");
  const btnToggle = document.getElementById("btnToggle");
  const widget = document.getElementById("widget");
  const btnExample = document.getElementById("btnExample");

  const dot = document.getElementById("dot");
  const statusEl = document.getElementById("status");

  // Lite formatting: bold + link + line breaks
  function escapeHtml(s){
    return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
  function formatLite(md){
    let s = escapeHtml(String(md||""));
    s = s.replace(/\*\*(.+?)\*\*/g, "<b>$1</b>");
    s = s.replace(/\[([^\]]+?)\]\((https?:\/\/[^\s)]+)\)/g, '<a href="$2" target="_blank" rel="noopener" style="color:#93c5fd;text-decoration:none">$1</a>');
    s = s.replace(/^###\s*(.+)$/gm, "<b>$1</b>");
    s = s.replace(/\n/g, "<br>");
    return s;
  }

  function add(role, content){
    const row = document.createElement("div");
    row.className = "msg " + (role === "me" ? "me" : "bot");

    const b = document.createElement("div");
    b.className = "bubble";
    b.innerHTML = formatLite(content);

    row.appendChild(b);
    chat.appendChild(row);
    chat.scrollTop = chat.scrollHeight;
  }

  function showTyping(show){
    let el = document.getElementById("typing");
    if(show){
      if(el) return;
      el = document.createElement("div");
      el.id = "typing";
      el.className = "typing";
      el.innerHTML = '<span>AI ƒëang so·∫°n</span><span class="dots"><i></i><i></i><i></i></span>';
      chat.appendChild(el);
      chat.scrollTop = chat.scrollHeight;
    }else{
      if(el) el.remove();
    }
  }

  async function ping(){
    try{
      const r = await fetch(API + "/health", {cache:"no-store"});
      const j = await r.json();
      dot.classList.remove("off");
      statusEl.textContent = "Online ‚Ä¢ " + (j.profile || "profile") ;
    }catch(_){
      dot.classList.add("off");
      statusEl.textContent = "Offline (kh√¥ng truy c·∫≠p ƒë∆∞·ª£c /health)";
    }
  }

  async function send(){
    const m = txt.value.trim();
    if(!m) return;

    add("me", m);
    txt.value = "";
    btn.disabled = true;
    showTyping(true);

    try{
      const res = await fetch(API + "/chat", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ message: m })
      });
      const data = await res.json();
      showTyping(false);
      add("bot", data.reply || "D·∫° em ch∆∞a nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi h·ª£p l·ªá. Anh/ch·ªã th·ª≠ l·∫°i gi√∫p em nh√© ·∫°.");
    }catch(e){
      showTyping(false);
      add("bot", "D·∫° h·ªá th·ªëng ƒëang b·∫≠n ho·∫∑c l·ªói k·∫øt n·ªëi. Anh/ch·ªã th·ª≠ t·∫£i l·∫°i trang gi√∫p em nh√© ·∫°.");
    }finally{
      btn.disabled = false;
      txt.focus();
    }
  }

  btn.onclick = send;
  txt.addEventListener("keydown", (e) => {
    if(e.key === "Enter" && !e.shiftKey){
      e.preventDefault();
      send();
    }
  });

  btnClear.onclick = () => {
    chat.innerHTML = "";
    add("bot","D·∫° em ch√†o anh/ch·ªã üòä Em l√† **Tr·ª£ l√Ω AI CSKH**. Anh/ch·ªã ƒëang c·∫ßn **t∆∞ v·∫•n s·∫£n ph·∫©m/combo**, hay **h∆∞·ªõng d·∫´n mua h√†ng** ·∫°?");
  };

  btnToggle.onclick = () => {
    widget.classList.toggle("collapsed");
    btnToggle.textContent = widget.classList.contains("collapsed") ? "‚ñ¥" : "‚ñæ";
  };

  btnExample.onclick = (e) => {
    e.preventDefault();
    txt.value = "Ng∆∞·ªùi b·ªã ti·ªÉu ƒë∆∞·ªùng d√πng combo n√†o? (Cho em t√™n combo, gi√°, link, c√°ch d√πng)";
    txt.focus();
  };

  // init
  add("bot","D·∫° em ch√†o anh/ch·ªã üòä Em l√† **Tr·ª£ l√Ω AI CSKH**. Anh/ch·ªã ƒëang c·∫ßn **t∆∞ v·∫•n s·∫£n ph·∫©m/combo**, hay **h∆∞·ªõng d·∫´n mua h√†ng** ·∫°?");
  ping();
</script>
</body>
</html>
